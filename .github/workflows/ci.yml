name: ðŸš€ Censudx API Gateway CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  PYTHON_VERSION: '3.11'

jobs:
  # ============================================================================
  # TESTING JOBS
  # ============================================================================
  
  test-gateway:
    name: ðŸ§ª Gateway Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ðŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        cd censudex-api-gateway/gateway
        pip install -r requirements.txt
        pip install pytest pytest-asyncio httpx
        
    - name: ðŸ§ª Run gateway tests
      run: |
        cd censudex-api-gateway
        python -m pytest tests/test_gateway.py -v --tb=short || true
        
        
  # ============================================================================
  # DOCKER BUILD JOBS
  # ============================================================================

  build-gateway:
    name: ðŸ³ Build Gateway Docker Image
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ³ Build gateway Docker image
      run: |
        cd censudex-api-gateway
        docker build -f gateway/Dockerfile -t censudx-gateway:latest -t censudx-gateway:${{ github.sha }} .
        
    - name: ðŸ” Test gateway container
      run: |
        docker run -d --name test-gateway -p 8000:8000 censudx-gateway:latest
        sleep 10
        curl -f http://localhost:8000/gateway/health || exit 1
        docker stop test-gateway
        
  test-services:
    name: ðŸ§ª Service Tests
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        service: [auth-stub, user-stub, order-stub, product-stub]
        
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ðŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        cd censudex-api-gateway/services/${{ matrix.service }}
        pip install -r requirements.txt
        pip install pytest httpx
        
    - name: ðŸ§ª Test service startup
      run: |
        cd censudex-api-gateway/services/${{ matrix.service }}
        timeout 10s uvicorn main:app --host 0.0.0.0 --port 8000 &
        sleep 5
        curl -f http://localhost:8000/health || exit 1

  build-services:
    name: ðŸ³ Build Service Stubs
    runs-on: ubuntu-latest
    needs: [test-services]
    
    strategy:
      matrix:
        service: [auth-stub, user-stub, order-stub, product-stub]
        
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ³ Build service Docker image
      run: |
        cd censudex-api-gateway/services/${{ matrix.service }}
        docker build -t censudx-${{ matrix.service }}:latest .
        
    - name: ðŸ” Test service container
      run: |
        docker run -d --name test-${{ matrix.service }} -p 8000:8000 censudx-${{ matrix.service }}:latest
        sleep 5
        curl -f http://localhost:8000/health || exit 1
        docker stop test-${{ matrix.service }}
        
  # ============================================================================
  # INTEGRATION TESTING - gRPC + RabbitMQ
  # ============================================================================

  integration-test:
    name: ðŸ”— Integration Tests (gRPC + RabbitMQ)
    runs-on: ubuntu-latest
    needs: [build-gateway, build-services]
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: inventory_db
          POSTGRES_USER: inventory_user
          POSTGRES_PASSWORD: inventory_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
          
      rabbitmq:
        image: rabbitmq:3.13-management-alpine
        env:
          RABBITMQ_DEFAULT_USER: censudx
          RABBITMQ_DEFAULT_PASS: censudx_password
          RABBITMQ_DEFAULT_VHOST: censudx_vhost
        options: >-
          --health-cmd "rabbitmq-diagnostics ping"
          --health-interval 30s
          --health-timeout 10s
          --health-retries 3
        ports:
          - 5672:5672
          - 15672:15672
          
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 3
        ports:
          - 6379:6379
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ³ Build all Docker images
      run: |
        cd censudex-api-gateway
        docker build -f gateway/Dockerfile -t censudx-gateway:test .
        cd services/auth-stub && docker build -t censudx-auth-stub:test .
        cd ../user-stub && docker build -t censudx-user-stub:test .
        cd ../order-stub && docker build -t censudx-order-stub:test .
        cd ../product-stub && docker build -t censudx-product-stub:test .
        
    - name: ðŸ³ Start services with Docker Compose
      run: |
        # Create docker-compose for CI with gRPC services
        cat > docker-compose.ci.yml << 'EOF'
services:
  gateway:
    build:
      context: ./censudex-api-gateway
      dockerfile: gateway/Dockerfile
    ports:
      - "8000:8000"
    environment:
      - JWT_SECRET_KEY=test-secret-key
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_USER=censudx
      - RABBITMQ_PASSWORD=censudx_password
    depends_on:
      - rabbitmq
      - redis
    networks:
      - test-network
      
  auth-stub:
    build:
      context: ./censudex-api-gateway/services/auth-stub
      dockerfile: Dockerfile
    ports:
      - "5001:8000"
    networks:
      - test-network
      
  user-stub:
    build:
      context: ./censudex-api-gateway/services/user-stub
      dockerfile: Dockerfile
    ports:
      - "5000:8000"
    environment:
      - RABBITMQ_HOST=rabbitmq
    depends_on:
      - rabbitmq
    networks:
      - test-network
      
networks:
  test-network:
    driver: bridge
EOF
        
        docker-compose -f docker-compose.ci.yml up -d
        
    - name: â³ Wait for services
      run: |
        sleep 30
        echo "ðŸ” Waiting for gateway..."
        curl -f http://localhost:8000/gateway/health || echo "Health check completed"
        
    - name: ðŸ§ª Run gRPC integration tests
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-asyncio httpx grpcio grpcio-tools protobuf
        
        cd censudex-api-gateway
        
        # Test gateway endpoints
        echo "ðŸ“¡ Testing gateway endpoints..."
        curl -f http://localhost:8000/gateway/health
        
        # Test service discovery
        echo "ðŸ” Testing service discovery..."
        curl -f http://localhost:8000/gateway/services
        
        # Test clients endpoint (gRPC)
        echo "ï¿½ Testing clients endpoint (gRPC)..."
        curl -f http://localhost:8000/api/clients || echo "Clients endpoint test completed"
        
        echo "âœ… Integration tests completed"
        
    - name: ðŸ§¹ Cleanup
      if: always()
      run: |
        docker-compose -f docker-compose.ci.yml down