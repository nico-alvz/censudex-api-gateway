name: Censudex Gateway CI

on:
  push:
    branches: [ main, develop, inventory-service ]
  pull_request:
    branches: [ main ]

env:
  PYTHON_VERSION: '3.11'
  JWT_SECRET_KEY: 'censudex-auth-service-super-secret-key-change-in-production-1234567890'
  RABBITMQ_URL: 'amqp://censudx:censudx_password@localhost:5672/censudex_vhost'
  POSTGRES_CONNECTION: 'Host=localhost;Port=5432;Database=inventory_db;Username=inventory_user;Password=inventory_password'

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        cd gateway
        pip install -r requirements.txt
        pip install pytest pytest-asyncio httpx
    - name: Run unit tests
      run: |
        python -m pytest tests/test_gateway.py -v --tb=short || true

  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Build Gateway
      run: |
        docker build -f gateway/Dockerfile -t censudx-gateway:ci .
    
    - name: Build Auth Service
      run: |
        cd censudex-auth-service
        docker build -f dockerfile -t censudx-auth:ci .
    
    - name: Build Clients Service
      run: |
        cd censudex-clients-service
        docker build -f dockerfile -t censudx-clients:ci .
    
    - name: Build Inventory Service
      run: |
        cd censudex-inventory-service
        docker build -f Dockerfile -t censudx-inventory:ci .
    
    - name: Save Docker images
      run: |
        docker save censudx-gateway:ci > /tmp/gateway.tar
        docker save censudx-auth:ci > /tmp/auth.tar
        docker save censudx-clients:ci > /tmp/clients.tar
        docker save censudx-inventory:ci > /tmp/inventory.tar
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: docker-images
        path: /tmp/*.tar
        retention-days: 1

  e2e-integration-tests:
    name: End-to-End Integration Tests
    runs-on: ubuntu-latest
    needs: [build]
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: inventory_db
          POSTGRES_USER: inventory_user
          POSTGRES_PASSWORD: inventory_password
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      rabbitmq:
        image: rabbitmq:3.13-management-alpine
        env:
          RABBITMQ_DEFAULT_USER: censudx
          RABBITMQ_DEFAULT_PASS: censudx_password
          RABBITMQ_DEFAULT_VHOST: censudex_vhost
        ports:
          - 5672:5672
          - 15672:15672
        options: >-
          --health-cmd "rabbitmq-diagnostics ping"
          --health-interval 30s
          --health-timeout 10s
          --health-retries 3
      
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 3
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download Docker images
      uses: actions/download-artifact@v3
      with:
        name: docker-images
        path: /tmp
    
    - name: Load Docker images
      run: |
        docker load < /tmp/gateway.tar
        docker load < /tmp/auth.tar
        docker load < /tmp/clients.tar
        docker load < /tmp/inventory.tar
    
    - name: Start Auth Service
      run: |
        docker run -d --name auth-service --network host \
          -e JWT_SIGNING_KEY="${JWT_SECRET_KEY}" \
          -e JWT_ISSUER=censudex-auth-service \
          -e JWT_AUDIENCE=censudex-api-users \
          -e ASPNETCORE_URLS=http://+:5001 \
          -e ASPNETCORE_ENVIRONMENT=Production \
          censudx-auth:ci
    
    - name: Start Clients Service
      run: |
        docker run -d --name clients-service --network host \
          -e PostgreSQLConnection="${POSTGRES_CONNECTION}" \
          -e PORT=5002 \
          -e RABBITMQ_HOST=localhost \
          -e RABBITMQ_USERNAME=censudx \
          -e RABBITMQ_PASSWORD=censudx_password \
          -e ASPNETCORE_URLS=http://+:5002 \
          -e ASPNETCORE_ENVIRONMENT=Production \
          censudx-clients:ci
    
    - name: Start Inventory Service
      run: |
        docker run -d --name inventory-service --network host \
          -e DATABASE_URL=postgresql://inventory_user:inventory_password@localhost:5432/inventory_db \
          -e RABBITMQ_URL="${RABBITMQ_URL}" \
          -e SECRET_KEY=inventory-service-secret \
          -e LOW_STOCK_THRESHOLD=10 \
          censudx-inventory:ci
    
    - name: Wait for services to be ready
      run: |
        echo "Waiting for services to start..."
        sleep 15
    
    - name: Start Gateway
      run: |
        docker run -d --name gateway --network host \
          -e JWT_SECRET_KEY="${JWT_SECRET_KEY}" \
          -e DATABASE_URL=postgresql://inventory_user:inventory_password@localhost:5432/inventory_db \
          -e RABBITMQ_URL="${RABBITMQ_URL}" \
          -e REDIS_URL=redis://localhost:6379/0 \
          -e AUTH_SERVICE_URL=http://localhost:5001 \
          -e CLIENTS_SERVICE_URL=localhost:5002 \
          -e INVENTORY_SERVICE_URL=http://localhost:8000 \
          censudx-gateway:ci
    
    - name: Wait for gateway to be healthy
      run: |
        echo "Waiting for gateway to be healthy..."
        sleep 10
        for i in {1..30}; do
          if curl -f http://localhost:8000/gateway/health; then
            echo "Gateway is healthy!"
            break
          fi
          echo "Waiting for gateway... ($i/30)"
          sleep 2
        done
    
    - name: Show service logs
      if: always()
      run: |
        echo "=== Gateway Logs ==="
        docker logs gateway || true
        echo "=== Auth Service Logs ==="
        docker logs auth-service || true
        echo "=== Clients Service Logs ==="
        docker logs clients-service || true
        echo "=== Inventory Service Logs ==="
        docker logs inventory-service || true
    
    - name: Install test dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-asyncio httpx
    
    - name: Run E2E integration tests
      run: |
        python -m pytest tests/test_e2e_flow.py -v --tb=short -m integration
    
    - name: Cleanup
      if: always()
      run: |
        docker stop gateway auth-service clients-service inventory-service || true
        docker rm gateway auth-service clients-service inventory-service || true
